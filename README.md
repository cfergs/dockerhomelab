# dockerhomelab
Self container docker homelab accessible via https. Certificates generated by letsencrypt. All sites are accessible via SSO or basic authentication (where required by NZB360). It's recommended you run this on 1 VM such as Alpine OS.

Contains

| Application   | URLs                                                                       | Purpose                                 |
|---------------|----------------------------------------------------------------------------|-----------------------------------------|
| Watchtower    | N/A                                                                        | Update containers to new versions       |
| ddclient      | N/A                                                                        | update DNS A records with IP changes    |
| OpenLDAP      | N/A                                                                        | single repository of user accounts      |
| Traefik       | N/A                                                                        | Reverse Proxy                           |
| Authelia      | https://AUTH_SUBDOMAIN.DOMAIN                                              | Single Signon frontend                  |
| PHPLDAPADMIN  | https://DOMAIN/phpldapadmin                                                | web interface for openldap              |
| Radarr        | https://DOMAIN/radarr && https://BASIC_SUBDOMAIN.DOMAIN/radarr             | Movie downloader                        |
| Sonarr        | https://DOMAIN/sonarr && https://BASIC_SUBDOMAIN.DOMAIN/sonarr             | TV show downloader                      |
| Bazarr        | https://DOMAIN/subtitles                                                   | Subtitle downloader                     |
| Lazylibrarian | https://DOMAIN/books                                                       | Book downloader                         |
| Mylar         | https://DOMAIN/comics                                                      | comic downloader                        |
| NZBHydra      | https://DOMAIN/hydra2 && https://BASIC_DOMAIN.DOMAIN/hydra2                | search multiple usenet indexers at once |
| Jackett       | https://DOMAIN/jackett && https://BASIC_SUBDOMAIN.DOMAIN/jackett           | search multiple torrent sites at once   |
| SABnzbd       | https://DOMAIN/sabnzbd && https://BASIC_SUBDOMAIN.DOMAIN/sabnzbd           | download from usenet                    |
| Transmission  | https://DOMAIN/transmission && https://BASIC_SUBDOMAIN.DOMAIN/transmission | download torrents                       |

![Image](assets/overview.png)

### Usage
#### Step 1 - Download files from git

#### Step 2 - Perms, Modify values for docker, openldap and authelia
1. Setup folder perms used for volumes (if used for linux, for windows enter creds in docker app)  
   - Create user account                                                                       
   - Create folders and grant user access. Although docker will create them you need to apply perms to grant access.
   - Get UID (PUID) and GID (PGID) of user. cmd: *id username*. Needed for .env file

2. Docker \
Update values as appropriate in file *.env*   \
For an example where i have the website name of example.com
  ```
  CONFIG=/mnt/config       
  DOWNLOAD=/mnt/download
  MEDIA=/mnt/media           
  PUID=1000                     
  PGID=1000                     
  DOMAIN=example.com            
  EMAIL=admin@example.com       
  SSOAUTH_SUBDOMAIN=auth        
  BASICAUTH_USER=basicuser      
  BASICAUTH_PASSWORD="encrypted password generated from https://www.htaccesstools.com/htpasswd-generator/"
  BASICAUTH_SUBDOMAIN=basic
  ```

3. OpenLDAP
   - update the passwords in */ldap/ldap.env* file
   - update */ldap/00-startup.ldif* to change domain from example.com to domain you wish to use

4. Authelia
   - Rename */authelia/configuration_template.yml* to *configuration.yml*
   - In file update values of
     - jwt_secret
     - base_dn
     - user
     - password
     - secret:domain
     - update domains (in rules)
   - Modify domain rules as required

#### Step 3 - Run
run `docker-compose up -d ` \
This will download all containers & create other folders where needed

#### Step 4 - Modify values
Some default values will need to be changed for your site to work.
1. (if running windows) Start by running updatebasevalues.ps1. This will change the domain url for many sites and grant access to sabnzbd & transmission. Otherwise good luck editing!
2. Login to Bazarr locally via http://localhost:6767 and update values accordingly
3. create users and admins group and user accounts in openldap (if not already) - if stuck for setting passwords connect to LDAPADMIN.exe tool using docker IP.
4. ddclient \
add values for your dynamic IP  \
for example if you were using namecheap and updating records for example.com,auth.example.com and basic.example.com it would be

  ```
  use=web
  web=dynamicdns.park-your-domain.com/getip
  protocol=namecheap,				\
  server=dynamicdns.park-your-domain.com,	\
  login=example.com,			\
  password=PASSWORD 
  @,auth,basic
  ```

#### Step 5 - Re-run as production
Once you have completed all steps and are satisified it will work hash out line in *docker-compose.yml* \
  *--certificatesResolvers.letsencrypt.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory* \
  Next re-run `docker-compose up -d` &  will now get a legit letsencrypt certificate